<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìä Instant Slides Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0f0f13;
            --card: #1a1a22;
            --border: rgba(255,255,255,0.08);
            --text: #f0f0f4;
            --muted: #6b6b80;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 30px 0 20px;
        }
        
        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--muted);
        }
        
        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* API Settings */
        .api-toggle {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .api-toggle:hover { border-color: rgba(255,255,255,0.15); }
        
        .api-toggle-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .api-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .api-status.connected { background: var(--success); }
        
        .api-panel {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .api-panel.open { display: block; }
        
        .api-panel input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .api-panel input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .api-link {
            font-size: 12px;
            color: var(--accent);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .api-link:hover { color: var(--accent-hover); }
        
        .btn-save {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .btn-save:hover { background: var(--accent-hover); }
        
        /* Textarea */
        textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 100px;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        textarea::placeholder { color: var(--muted); }
        
        .url-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .url-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .url-input::placeholder { color: var(--muted); }
        
        .url-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }
        
        /* Options */
        .options-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .option-group {
            flex: 1;
        }
        
        .option-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
            display: block;
        }
        
        .option-buttons {
            display: flex;
            gap: 6px;
        }
        
        .opt-btn {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 8px;
            color: var(--muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .opt-btn:hover {
            border-color: rgba(255,255,255,0.2);
            color: var(--text);
        }
        
        .opt-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Styles grid */
        .styles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        
        .style-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .style-btn:hover {
            border-color: rgba(255,255,255,0.2);
        }
        
        .style-btn.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .style-icon { font-size: 22px; margin-bottom: 6px; }
        .style-name { font-size: 12px; font-weight: 500; color: var(--text); }
        
        /* Generate button */
        .btn-generate {
            width: 100%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 18px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-family: inherit;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
        }
        
        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            color: var(--muted);
            font-size: 14px;
        }
        
        /* Result */
        .result {
            display: none;
        }
        
        .result.show { display: block; }
        
        .success-icon {
            text-align: center;
            font-size: 50px;
            margin-bottom: 16px;
        }
        
        .success-title {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .success-subtitle {
            text-align: center;
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 24px;
        }
        
        .slide-preview {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
        }
        
        .slide-num {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }
        
        .slide-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        
        .btn-download {
            width: 100%;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 18px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .btn-download:hover {
            background: #059669;
        }
        
        .btn-reset {
            width: 100%;
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .btn-reset:hover {
            border-color: rgba(255,255,255,0.2);
            color: var(--text);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            font-size: 12px;
            color: var(--muted);
        }
        
        .footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        /* iTabs Button */
        .itabs-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5a623, #e8871e);
            border: none;
            color: #0a0a0e;
            font-size: 24px;
            font-weight: 700;
            font-style: italic;
            font-family: Georgia, serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(245, 166, 35, 0.3);
        }
        
        .itabs-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(245, 166, 35, 0.4);
        }
        
        /* iTabs Overlay */
        .itabs-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        
        .itabs-overlay.open {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        /* iTabs Popup */
        .itabs-popup {
            width: 100%;
            max-width: 400px;
            height: min(80vh, 600px);
            background: #12121a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .itabs-overlay.open .itabs-popup {
            transform: scale(1) translateY(0);
        }
        
        .itabs-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background 0.2s;
        }
        
        .itabs-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .itabs-progress {
            display: flex;
            gap: 4px;
            padding: 16px 20px 12px;
        }
        
        .itabs-seg {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .itabs-seg.active {
            background: #f5a623;
            box-shadow: 0 0 8px rgba(245,166,35,0.4);
        }
        
        .itabs-seg.done {
            background: rgba(245,166,35,0.5);
        }
        
        .itabs-cards {
            flex: 1;
            position: relative;
            overflow: hidden;
            margin: 0 12px;
        }
        
        .itabs-card {
            position: absolute;
            inset: 0;
            opacity: 0;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }
        
        .itabs-card.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        
        .itabs-card.prev {
            opacity: 0;
            transform: translateX(-100%);
        }
        
        .itabs-card-inner {
            flex: 1;
            background: #1a1a22;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 24px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .itabs-card-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }
        
        .itabs-card-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #f5a623;
            margin-bottom: 8px;
        }
        
        .itabs-card-title {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 12px;
        }
        
        .itabs-card-text {
            font-size: 15px;
            line-height: 1.7;
            color: #6b6b80;
            margin-bottom: 16px;
        }
        
        .itabs-card-text strong {
            color: #f0f0f4;
        }
        
        .itabs-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: auto;
        }
        
        .itabs-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 500;
            color: #f0f0f4;
            cursor: pointer;
            transition: all 0.25s;
        }
        
        .itabs-chip:hover {
            background: #f5a623;
            border-color: #f5a623;
            color: #0a0a0e;
        }
        
        .itabs-chip-i {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #f5a623;
            color: #0a0a0e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            font-style: italic;
            font-family: Georgia, serif;
        }
        
        .itabs-chip:hover .itabs-chip-i {
            background: #0a0a0e;
            color: #f5a623;
        }
        
        /* Download button inside iTabs */
        .itabs-download {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            background: linear-gradient(135deg, #f5a623, #e8871e);
            color: #0a0a0e;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .itabs-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245,166,35,0.3);
        }
        
        .itabs-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px 16px;
        }
        
        .itabs-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #1a1a22;
            border: 1px solid rgba(255,255,255,0.1);
            color: #6b6b80;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .itabs-nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #f0f0f4;
        }
        
        .itabs-nav-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }
        
        .itabs-nav-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2.5;
        }
        
        .itabs-count {
            font-size: 14px;
            color: #6b6b80;
        }
        
        /* Info sheet for i-buttons */
        .info-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 300;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.25s, visibility 0.25s;
        }
        
        .info-overlay.open {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        .info-sheet {
            width: 100%;
            max-width: 400px;
            background: #1a1a22;
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: none;
            border-radius: 20px 20px 0 0;
            max-height: 50vh;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
        }
        
        .info-overlay.open .info-sheet {
            transform: translateY(0);
        }
        
        .info-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-title {
            font-weight: 700;
            font-size: 16px;
        }
        
        .info-badge {
            font-size: 10px;
            padding: 4px 10px;
            background: #f5a623;
            color: #0a0a0e;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .info-close {
            margin-left: auto;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        
        .info-body {
            padding: 20px;
            font-size: 15px;
            line-height: 1.7;
            color: #6b6b80;
            overflow-y: auto;
            max-height: calc(50vh - 60px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üìä</div>
            <h1 class="title">Instant Slides</h1>
            <p class="subtitle">Describe it ‚Üí Download PowerPoint</p>
        </div>
        
        <!-- API Settings Toggle -->
        <div class="api-toggle" onclick="toggleAPI()">
            <div class="api-toggle-left">
                <span>‚öôÔ∏è</span>
                <span>API Settings</span>
            </div>
            <div class="api-status" id="apiStatus"></div>
        </div>
        
        <!-- API Panel -->
        <div class="api-panel" id="apiPanel">
            <input type="password" id="apiKey" placeholder="Paste your Gemini API key">
            <a class="api-link" href="https://aistudio.google.com/app/apikey" target="_blank">
                Get a free key from Google ‚Üí
            </a>
            <br>
            <button class="btn-save" onclick="saveAPI()">Save Key</button>
        </div>
        
        <!-- Main Form -->
        <div class="card" id="formCard">
            <div class="card-title">üîó Add a URL for context (optional)</div>
            <input type="url" id="contextUrl" class="url-input" placeholder="https://example.com/article-or-page">
            <div class="url-hint">Paste a webpage, article, or doc ‚Äî AI will read it for context</div>
            
            <div class="card-title" style="margin-top: 20px;">üìù What's your presentation about?</div>
            <textarea id="topic" placeholder="e.g. Create a 5-slide summary of this article, focusing on the key takeaways and stats."></textarea>
            
            <div class="options-row">
                <div class="option-group">
                    <span class="option-label">Slides</span>
                    <div class="option-buttons">
                        <button class="opt-btn active" data-slides="5">5</button>
                        <button class="opt-btn" data-slides="8">8</button>
                        <button class="opt-btn" data-slides="10">10</button>
                    </div>
                </div>
            </div>
            
            <div class="card-title" style="margin-top: 20px;">üé® Pick a style</div>
            <div class="styles-grid">
                <div class="style-btn active" data-style="professional">
                    <div class="style-icon">üíº</div>
                    <div class="style-name">Professional</div>
                </div>
                <div class="style-btn" data-style="bold">
                    <div class="style-icon">üî•</div>
                    <div class="style-name">Bold</div>
                </div>
                <div class="style-btn" data-style="minimal">
                    <div class="style-icon">‚ú®</div>
                    <div class="style-name">Minimal</div>
                </div>
                <div class="style-btn" data-style="creative">
                    <div class="style-icon">üé®</div>
                    <div class="style-name">Creative</div>
                </div>
                <div class="style-btn" data-style="dark">
                    <div class="style-icon">üåô</div>
                    <div class="style-name">Dark</div>
                </div>
                <div class="style-btn" data-style="warm">
                    <div class="style-icon">‚òÄÔ∏è</div>
                    <div class="style-name">Warm</div>
                </div>
            </div>
            
            <button class="btn-generate" id="btnGenerate" onclick="generate()">
                Generate Slides ‚ú®
            </button>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Creating your presentation...</div>
        </div>
        
        <!-- Result -->
        <div class="result" id="result">
            <div class="card">
                <div class="success-icon">‚úÖ</div>
                <div class="success-title">Presentation Ready!</div>
                <div class="success-subtitle" id="slideCount">5 slides created</div>
                
                <div id="slidePreviews"></div>
                
                <button class="btn-download" id="btnDownload">
                    üì• Download PowerPoint
                </button>
                
                <button class="btn-reset" onclick="reset()">
                    Create Another
                </button>
            </div>
        </div>
        
        <div class="footer">
            Built with ‚ù§Ô∏è ‚Ä¢ <a href="https://itabs.ai">itabs.ai</a>
        </div>
    </div>
    
    <!-- iTabs Button -->
    <button class="itabs-btn" onclick="toggleiTabs()">i</button>
    
    <!-- iTabs Popup -->
    <div class="itabs-overlay" id="itabsOverlay">
        <div class="itabs-popup">
            <div class="itabs-progress" id="itabsProgress"></div>
            <div class="itabs-cards" id="itabsCards"></div>
            <div class="itabs-nav">
                <button class="itabs-nav-btn" id="itabsPrev" disabled><svg><path d="M15 18l-6-6 6-6"/></svg></button>
                <span class="itabs-count" id="itabsCount">1 / 4</span>
                <button class="itabs-nav-btn" id="itabsNext"><svg><path d="M9 6l6 6-6 6"/></svg></button>
            </div>
            <button class="itabs-close" onclick="toggleiTabs()">√ó</button>
        </div>
    </div>
    
    <!-- Info Sheet (for i-buttons inside iTabs) -->
    <div class="info-overlay" id="infoOverlay">
        <div class="info-sheet">
            <div class="info-header">
                <span class="info-title" id="infoTitle"></span>
                <span class="info-badge" id="infoBadge"></span>
                <button class="info-close" onclick="closeInfo()">√ó</button>
            </div>
            <div class="info-body" id="infoBody"></div>
        </div>
    </div>

<script>
// ============================================
// STATE
// ============================================
let selectedSlides = 5;
let selectedStyle = 'professional';
let generatedSlides = null;
let pptx = null;

// ============================================
// STYLE PALETTES
// ============================================
const STYLES = {
    professional: {
        name: 'Professional',
        bg: 'FFFFFF',
        bgAlt: 'F8FAFC',
        primary: '1E3A5F',
        accent: '3B82F6',
        text: '1E293B',
        muted: '64748B'
    },
    bold: {
        name: 'Bold',
        bg: '1E293B',
        bgAlt: '334155',
        primary: 'FFFFFF',
        accent: 'F43F5E',
        text: 'FFFFFF',
        muted: '94A3B8'
    },
    minimal: {
        name: 'Minimal',
        bg: 'FFFFFF',
        bgAlt: 'F9FAFB',
        primary: '111827',
        accent: '111827',
        text: '374151',
        muted: '9CA3AF'
    },
    creative: {
        name: 'Creative',
        bg: 'FDF4FF',
        bgAlt: 'FAE8FF',
        primary: '701A75',
        accent: 'A855F7',
        text: '581C87',
        muted: '9333EA'
    },
    dark: {
        name: 'Dark',
        bg: '0F0F13',
        bgAlt: '1A1A22',
        primary: 'FFFFFF',
        accent: '6366F1',
        text: 'E2E8F0',
        muted: '64748B'
    },
    warm: {
        name: 'Warm',
        bg: 'FFFBEB',
        bgAlt: 'FEF3C7',
        primary: '78350F',
        accent: 'F59E0B',
        text: '451A03',
        muted: '92400E'
    }
};

// ============================================
// API MANAGEMENT
// ============================================
function toggleAPI() {
    document.getElementById('apiPanel').classList.toggle('open');
}

function saveAPI() {
    const key = document.getElementById('apiKey').value.trim();
    if (key) {
        localStorage.setItem('gemini_api_key', key);
        updateAPIStatus();
        toggleAPI();
    }
}

function updateAPIStatus() {
    const key = localStorage.getItem('gemini_api_key');
    const status = document.getElementById('apiStatus');
    if (key) {
        status.classList.add('connected');
        document.getElementById('apiKey').value = key;
    } else {
        status.classList.remove('connected');
    }
}

// ============================================
// UI HANDLERS
// ============================================
document.querySelectorAll('.opt-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedSlides = parseInt(btn.dataset.slides);
    });
});

document.querySelectorAll('.style-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedStyle = btn.dataset.style;
    });
});

function toggleiTabs() {
    document.getElementById('itabsOverlay').classList.toggle('open');
}

function closeHelp(e) {
    if (e.target.id === 'itabsOverlay') {
        toggleiTabs();
    }
}

// iTabs popup content
const ITABS_SLIDES = [
    {
        icon: "üìä",
        label: "This Tool",
        title: "Instant Slides",
        text: "Describe what you want, paste a URL for context, pick a style ‚Äî <strong>download a PowerPoint in seconds</strong>. No design skills needed.",
        chips: [
            { term: "How it works", type: "Process", body: "You describe your presentation (or paste a URL). Gemini AI generates the content and structure. PptxGenJS builds the actual .pptx file right in your browser. No server, no uploads, no account needed." },
            { term: "Free to use", type: "Info", body: "The tool is completely free. You just need a Gemini API key from Google (also free). Your key stays in your browser ‚Äî we never see it." }
        ]
    },
    {
        icon: "ü§ñ",
        label: "Power Users",
        title: "Want this inside Claude?",
        text: "Download the <strong>iTabs Slides skill</strong> and use it directly in Claude. Same magic, but integrated into your AI workflow.",
        chips: [
            { term: "What's a skill?", type: "Definition", body: "A skill is a file that teaches Claude how to do something specific. Upload it once, and Claude can generate iTabs-style presentations whenever you ask." },
            { term: "Why use it?", type: "Benefit", body: "If you're already chatting with Claude and want slides, you don't need to switch to another tool. Just ask Claude to make a presentation ‚Äî it'll use the skill automatically." }
        ]
    },
    {
        icon: "üí°",
        label: "The Format",
        title: "iTabs ‚Äî Hidden Information",
        text: "Every presentation has <strong>more depth than you see</strong>. The 'i' buttons reveal context, definitions, sources ‚Äî only when you want them.",
        chips: [
            { term: "Why hidden?", type: "Concept", body: "Not everyone needs every detail. Hidden info keeps the surface clean for those who want headlines, but the depth is there for those who want it. You control what you see." },
            { term: "Try it now", type: "Interactive", body: "You just did! This panel you're reading is hidden information. It was here the whole time, but only appeared when you tapped. That's iTabs." }
        ]
    },
    {
        icon: "‚¨áÔ∏è",
        label: "Get the Skill",
        title: "Use with Claude",
        text: "Download the skill file, upload it to Claude, and ask for presentations anytime. <strong>The iTabs format travels with you.</strong>",
        chips: [
            { term: "How to install", type: "Steps", body: "1. Download the .skill file below. 2. In Claude, go to your Skills folder. 3. Upload the file. 4. Done! Now just ask Claude to make a presentation." }
        ],
        download: true
    }
];

let itabsIndex = 0;

// Build iTabs popup
function buildItabsPopup() {
    const progress = document.getElementById('itabsProgress');
    const cards = document.getElementById('itabsCards');
    
    progress.innerHTML = '';
    cards.innerHTML = '';
    
    ITABS_SLIDES.forEach((slide, i) => {
        // Progress segment
        const seg = document.createElement('div');
        seg.className = 'itabs-seg' + (i === 0 ? ' active' : '');
        seg.addEventListener('click', () => goToItabs(i));
        progress.appendChild(seg);
        
        // Card
        const card = document.createElement('div');
        card.className = 'itabs-card' + (i === 0 ? ' active' : '');
        
        let chipsHTML = '';
        if (slide.chips && slide.chips.length) {
            chipsHTML = '<div class="itabs-chips">' + slide.chips.map(c => `
                <button class="itabs-chip" data-term="${c.term}" data-type="${c.type}" data-body="${encodeURIComponent(c.body)}">
                    <span class="itabs-chip-i">i</span>${c.term}
                </button>
            `).join('') + '</div>';
        }
        
        let downloadHTML = '';
        if (slide.download) {
            downloadHTML = `<a class="itabs-download" href="itabs-slides.skill" download>
                <span>‚¨áÔ∏è</span> Download Skill File
            </a>`;
        }
        
        card.innerHTML = `
            <div class="itabs-card-inner">
                <div class="itabs-card-icon">${slide.icon}</div>
                <div class="itabs-card-label">${slide.label}</div>
                <div class="itabs-card-title">${slide.title}</div>
                <div class="itabs-card-text">${slide.text}</div>
                ${chipsHTML}
                ${downloadHTML}
            </div>
        `;
        
        cards.appendChild(card);
    });
    
    // Wire up chips
    document.querySelectorAll('.itabs-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.getElementById('infoTitle').textContent = chip.dataset.term;
            document.getElementById('infoBadge').textContent = chip.dataset.type;
            document.getElementById('infoBody').textContent = decodeURIComponent(chip.dataset.body);
            document.getElementById('infoOverlay').classList.add('open');
        });
    });
}

function goToItabs(i) {
    if (i < 0 || i >= ITABS_SLIDES.length) return;
    itabsIndex = i;
    
    document.querySelectorAll('.itabs-card').forEach((c, idx) => {
        c.classList.remove('active', 'prev');
        if (idx === i) c.classList.add('active');
        else if (idx < i) c.classList.add('prev');
    });
    
    document.querySelectorAll('.itabs-seg').forEach((s, idx) => {
        s.classList.remove('active', 'done');
        if (idx === i) s.classList.add('active');
        else if (idx < i) s.classList.add('done');
    });
    
    document.getElementById('itabsPrev').disabled = i === 0;
    document.getElementById('itabsNext').disabled = i === ITABS_SLIDES.length - 1;
    document.getElementById('itabsCount').textContent = `${i + 1} / ${ITABS_SLIDES.length}`;
}

function closeInfo() {
    document.getElementById('infoOverlay').classList.remove('open');
}

// iTabs navigation
document.getElementById('itabsPrev').addEventListener('click', () => goToItabs(itabsIndex - 1));
document.getElementById('itabsNext').addEventListener('click', () => goToItabs(itabsIndex + 1));

// Swipe support for iTabs
let itabsTouchX = 0;
document.getElementById('itabsCards').addEventListener('touchstart', e => { itabsTouchX = e.touches[0].clientX; });
document.getElementById('itabsCards').addEventListener('touchend', e => {
    const diff = itabsTouchX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) goToItabs(itabsIndex + (diff > 0 ? 1 : -1));
});

// Close on overlay click
document.getElementById('itabsOverlay').addEventListener('click', e => {
    if (e.target.id === 'itabsOverlay') toggleiTabs();
});
document.getElementById('infoOverlay').addEventListener('click', e => {
    if (e.target.id === 'infoOverlay') closeInfo();
});

// Keyboard for iTabs
document.addEventListener('keydown', e => {
    if (document.getElementById('infoOverlay').classList.contains('open')) {
        if (e.key === 'Escape') closeInfo();
        return;
    }
    if (document.getElementById('itabsOverlay').classList.contains('open')) {
        if (e.key === 'Escape') toggleiTabs();
        if (e.key === 'ArrowRight') goToItabs(itabsIndex + 1);
        if (e.key === 'ArrowLeft') goToItabs(itabsIndex - 1);
    }
});

// Build iTabs on load
buildItabsPopup();

// ============================================
// MAIN GENERATION
// ============================================
async function generate() {
    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) {
        alert('Please add your Gemini API key first!');
        toggleAPI();
        return;
    }
    
    const topic = document.getElementById('topic').value.trim();
    const contextUrl = document.getElementById('contextUrl').value.trim();
    
    if (!topic && !contextUrl) {
        alert('Please describe what your presentation is about, or provide a URL!');
        return;
    }
    
    // Show loading
    document.getElementById('formCard').style.display = 'none';
    document.getElementById('loading').classList.add('show');
    document.getElementById('btnGenerate').disabled = true;
    
    try {
        // Fetch URL content if provided
        let urlContent = '';
        if (contextUrl) {
            document.querySelector('.loading-text').textContent = 'Reading webpage...';
            urlContent = await fetchUrlContent(apiKey, contextUrl);
        }
        
        document.querySelector('.loading-text').textContent = 'Creating your presentation...';
        
        // Generate content with Gemini
        const slides = await generateContent(apiKey, topic, selectedSlides, selectedStyle, urlContent);
        generatedSlides = slides;
        
        // Build PowerPoint
        buildPowerPoint(slides, STYLES[selectedStyle]);
        
        // Show result
        document.getElementById('loading').classList.remove('show');
        document.getElementById('result').classList.add('show');
        document.getElementById('slideCount').textContent = `${slides.length} slides created`;
        
        // Show previews
        const previews = document.getElementById('slidePreviews');
        previews.innerHTML = slides.map((s, i) => `
            <div class="slide-preview">
                <div class="slide-num">SLIDE ${i + 1}</div>
                <div class="slide-title">${s.title}</div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error(error);
        alert('Error generating presentation: ' + error.message);
        reset();
    }
}

async function fetchUrlContent(apiKey, url) {
    // Use Gemini to fetch and summarise the URL content
    const prompt = `Fetch and extract the main content from this URL: ${url}

Return the key information including:
- Main topic/title
- Key points and facts
- Any statistics or data
- Important quotes or statements

Return as plain text summary, max 2000 words. Focus on factual content that could be used in a presentation.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.3 }
        })
    });
    
    const data = await response.json();
    
    if (data.error) {
        console.warn('Could not fetch URL:', data.error.message);
        return '';
    }
    
    return data.candidates[0]?.content?.parts[0]?.text || '';
}

async function generateContent(apiKey, topic, numSlides, style, urlContent = '') {
    let contextSection = '';
    if (urlContent) {
        contextSection = `

SOURCE CONTENT (use this as the basis for the presentation):
---
${urlContent}
---

`;
    }
    
    const prompt = `Create a ${numSlides}-slide presentation.

USER REQUEST: ${topic || 'Create a presentation summarising the key points from the source content'}
${contextSection}
Style: ${STYLES[style].name}

Return ONLY a JSON array with this exact structure (no markdown, no explanation):
[
  {
    "title": "Slide Title",
    "subtitle": "Optional subtitle or tagline",
    "bullets": ["Point 1", "Point 2", "Point 3"],
    "type": "title|content|bullets|stats|closing"
  }
]

Rules:
- First slide should be type "title" with a compelling title and subtitle
- Last slide should be type "closing" with a call to action or summary
- Middle slides should be type "content", "bullets", or "stats"
- For "stats" type, include 2-3 big numbers in bullets like "85% - Customer satisfaction rate"
- Keep bullet points concise (under 10 words each)
- Make titles punchy and engaging
- Use facts and data from the source content if provided
- Exactly ${numSlides} slides`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7 }
        })
    });
    
    const data = await response.json();
    
    if (data.error) {
        throw new Error(data.error.message);
    }
    
    let text = data.candidates[0].content.parts[0].text;
    
    // Clean up response - remove markdown code blocks if present
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    return JSON.parse(text);
}

// ============================================
// POWERPOINT BUILDER
// ============================================
function buildPowerPoint(slides, style) {
    if (typeof PptxGenJS === 'undefined') {
        throw new Error('PowerPoint library failed to load. Please refresh the page and try again.');
    }
    pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';
    pptx.title = slides[0]?.title || 'Presentation';
    
    slides.forEach((slideData, index) => {
        const slide = pptx.addSlide();
        
        // Background
        const isAlt = index % 2 === 1;
        slide.background = { color: isAlt ? style.bgAlt : style.bg };
        
        if (slideData.type === 'title') {
            buildTitleSlide(slide, slideData, style);
        } else if (slideData.type === 'closing') {
            buildClosingSlide(slide, slideData, style);
        } else if (slideData.type === 'stats') {
            buildStatsSlide(slide, slideData, style);
        } else {
            buildContentSlide(slide, slideData, style);
        }
    });
}

function buildTitleSlide(slide, data, style) {
    // Accent bar
    slide.addShape(pptx.shapes.RECTANGLE, {
        x: 0, y: 0, w: 10, h: 0.1,
        fill: { color: style.accent }
    });
    
    // Title
    slide.addText(data.title, {
        x: 0.5, y: 1.8, w: 9, h: 1.2,
        fontSize: 44, fontFace: 'Arial', bold: true,
        color: style.primary, align: 'center'
    });
    
    // Subtitle
    if (data.subtitle) {
        slide.addText(data.subtitle, {
            x: 0.5, y: 3.1, w: 9, h: 0.8,
            fontSize: 22, fontFace: 'Arial',
            color: style.muted, align: 'center'
        });
    }
    
    // Bottom accent
    slide.addShape(pptx.shapes.RECTANGLE, {
        x: 4, y: 4.3, w: 2, h: 0.06,
        fill: { color: style.accent }
    });
}

function buildContentSlide(slide, data, style) {
    // Title
    slide.addText(data.title, {
        x: 0.5, y: 0.4, w: 9, h: 0.8,
        fontSize: 32, fontFace: 'Arial', bold: true,
        color: style.primary
    });
    
    // Accent line
    slide.addShape(pptx.shapes.RECTANGLE, {
        x: 0.5, y: 1.1, w: 1.5, h: 0.05,
        fill: { color: style.accent }
    });
    
    // Bullets
    if (data.bullets && data.bullets.length) {
        const bulletText = data.bullets.map((b, i) => ({
            text: b,
            options: { bullet: true, breakLine: i < data.bullets.length - 1 }
        }));
        
        slide.addText(bulletText, {
            x: 0.5, y: 1.5, w: 9, h: 3.5,
            fontSize: 20, fontFace: 'Arial',
            color: style.text, valign: 'top',
            paraSpaceAfter: 14
        });
    }
}

function buildStatsSlide(slide, data, style) {
    // Title
    slide.addText(data.title, {
        x: 0.5, y: 0.4, w: 9, h: 0.8,
        fontSize: 32, fontFace: 'Arial', bold: true,
        color: style.primary
    });
    
    // Stats in columns
    if (data.bullets && data.bullets.length) {
        const numStats = Math.min(data.bullets.length, 3);
        const colWidth = 9 / numStats;
        
        data.bullets.slice(0, 3).forEach((stat, i) => {
            const parts = stat.split(' - ');
            const number = parts[0] || stat;
            const label = parts[1] || '';
            
            // Number
            slide.addText(number, {
                x: 0.5 + (i * colWidth), y: 1.8, w: colWidth, h: 1,
                fontSize: 48, fontFace: 'Arial', bold: true,
                color: style.accent, align: 'center'
            });
            
            // Label
            if (label) {
                slide.addText(label, {
                    x: 0.5 + (i * colWidth), y: 2.8, w: colWidth, h: 0.8,
                    fontSize: 16, fontFace: 'Arial',
                    color: style.muted, align: 'center'
                });
            }
        });
    }
}

function buildClosingSlide(slide, data, style) {
    // Background accent block
    slide.addShape(pptx.shapes.RECTANGLE, {
        x: 0, y: 0, w: 10, h: 2.5,
        fill: { color: style.accent }
    });
    
    // Title
    slide.addText(data.title, {
        x: 0.5, y: 0.7, w: 9, h: 1,
        fontSize: 38, fontFace: 'Arial', bold: true,
        color: style.bg === 'FFFFFF' || style.bg === 'FDF4FF' || style.bg === 'FFFBEB' ? 'FFFFFF' : style.bg,
        align: 'center'
    });
    
    // Subtitle
    if (data.subtitle) {
        slide.addText(data.subtitle, {
            x: 0.5, y: 1.6, w: 9, h: 0.6,
            fontSize: 20, fontFace: 'Arial',
            color: style.bg === 'FFFFFF' || style.bg === 'FDF4FF' || style.bg === 'FFFBEB' ? 'FFFFFF' : style.bg,
            align: 'center'
        });
    }
    
    // Bullets below
    if (data.bullets && data.bullets.length) {
        const bulletText = data.bullets.map((b, i) => ({
            text: b,
            options: { bullet: true, breakLine: i < data.bullets.length - 1 }
        }));
        
        slide.addText(bulletText, {
            x: 1.5, y: 3, w: 7, h: 2,
            fontSize: 18, fontFace: 'Arial',
            color: style.text, align: 'center'
        });
    }
}

// ============================================
// DOWNLOAD & RESET
// ============================================
document.getElementById('btnDownload').addEventListener('click', () => {
    if (pptx) {
        const filename = generatedSlides[0]?.title?.replace(/[^a-zA-Z0-9]/g, '_') || 'Presentation';
        pptx.writeFile({ fileName: `${filename}.pptx` });
    }
});

function reset() {
    document.getElementById('formCard').style.display = 'block';
    document.getElementById('loading').classList.remove('show');
    document.getElementById('result').classList.remove('show');
    document.getElementById('btnGenerate').disabled = false;
    document.getElementById('topic').value = '';
    document.getElementById('contextUrl').value = '';
    document.querySelector('.loading-text').textContent = 'Creating your presentation...';
    generatedSlides = null;
    pptx = null;
}

// ============================================
// INIT
// ============================================
updateAPIStatus();
</script>
</body>
</html>
